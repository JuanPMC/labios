cmake_minimum_required(VERSION 3.5)
project(aetrio)

set(CMAKE_CXX_STANDARD 14)
include_directories(external_libs/)
#define ones we have installed
set(MEMCACHED true)
set(NATS true)
set(MPI true)
#set(ROCKS true)
set(LIB_DIR /usr/local/lib)
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DDEBUG")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERMDM")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERTS")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERTB")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERNATS")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERDM")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERW")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMER")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DCOLLECT")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTIMERBASE")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DTABIOS")

set(CMAKE_MODULE_PATH )
set(COMMON_SRC "" src/common/solver/default_solver.cpp src/common/solver/default_solver.h src/common/config_manager.h src/common/config_manager.cpp src/common/solver/dp_solver.cpp src/common/solver/dp_solver.h src/common/solver/solver.h src/common/solver/random_solver.cpp src/common/solver/random_solver.h src/common/solver/round_robin_solver.cpp src/common/solver/round_robin_solver.h src/common/solver/knapsack.cpp external_libs/cereal/cereal.hpp src/common/timer.h src/common/timer.cpp src/common/enumerations.h src/common/exceptions.h src/common/data_structures.h src/common/data_manager/data_manager.cpp src/common/data_manager/data_manager.h src/common/client_interface/distributed_hashmap.cpp src/common/client_interface/distributed_hashmap.h src/common/utilities.h src/common/metadata_manager/metadata_manager.cpp src/common/metadata_manager/metadata_manager.h src/common/constants.h src/aetrio_system.cpp src/aetrio_system.h src/common/task_builder/task_builder.cpp src/common/task_builder/task_builder.h src/common/client_interface/distributed_hashmap.cpp src/common/client_interface/distributed_hashmap.h src/common/client_interface/distributed_queue.cpp src/common/client_interface/distributed_queue.h src/common/external_clients/serialization_manager.cpp src/common/external_clients/serialization_manager.h src/common/external_clients/rocksdb_impl.cpp src/common/external_clients/rocksdb_impl.h src/common/external_clients/memcached_impl.cpp src/common/external_clients/memcached_impl.h src/common/external_clients/nats_impl.cpp src/common/external_clients/nats_impl.h)
set(AETRIO_LIB_SRC ${COMMON_SRC} testing/trace_replayer.h testing/trace_replayer.cpp src/lib/driver.cpp src/lib/posix.cpp src/lib/posix.h src/lib/mpi.h src/lib/mpi.cpp src/common/return_codes.h src/common/threadPool.cpp src/common/threadPool.h testing/trace_replayer.cpp testing/trace_replayer.h)
set(AETRIO_CLIENT_SRC  ${COMMON_SRC} "src/client/main.cpp" src/client/client.cpp src/client/client.h src/common/exceptions.h include/aetrio.h src/common/return_codes.h src/common/threadPool.cpp src/common/threadPool.h)
set(AETRIO_SERVER_SRC  ${COMMON_SRC} "src/system_manager/main.cpp" src/system_manager/system_manager_service.cpp src/system_manager/system_manager_service.h src/common/return_codes.h src/common/threadPool.cpp src/common/threadPool.h)
set(AETRIO_TS_SRC  ${COMMON_SRC} src/task_scheduler/main.cpp src/task_scheduler/task_scheduler.cpp src/task_scheduler/task_scheduler.h src/common/return_codes.h src/common/threadPool.cpp src/common/threadPool.h)
set(AETRIO_WM_SRC  ${COMMON_SRC} "src/worker_manager/main.cpp" src/worker_manager/worker_manager_service.cpp src/worker_manager/worker_manager_service.h src/common/return_codes.h src/common/threadPool.cpp src/common/threadPool.h)
set(AETRIO_W_PROG_REPO src/worker/api/io_client.h src/worker/api/posix_client.cpp src/worker/api/posix_client.h src/worker/program_repo/statistics.h src/worker/program_repo/statistics.cpp src/common/return_codes.h)
set(AETRIO_WS_SRC  ${COMMON_SRC} ${AETRIO_W_PROG_REPO} src/worker/main.cpp src/worker/worker.cpp src/worker/worker.h src/common/return_codes.h src/common/threadPool.cpp src/common/threadPool.h)


if(DEFINED MPI)
    find_package(MPI REQUIRED)
    set(CMAKE_CXX_COMPILE_FLAGS ${CMAKE_CXX_COMPILE_FLAGS} ${MPI_COMPILE_FLAGS})
    set(CMAKE_CXX_LINK_FLAGS ${CMAKE_CXX_LINK_FLAGS} ${MPI_LINK_FLAGS})
    include_directories(${MPI_INCLUDE_PATH})
endif()
if(DEFINED MEMCACHED)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -L${LIB_DIR} -lmemcached -DMEMCACHED_P")
endif()
if(DEFINED ROCKS)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DROCKS_P")
    include_directories(/home/hariharan/Downloads/rocksdb/include)
endif()
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -w")


add_executable(aetrio_lib ${AETRIO_LIB_SRC} testing/trace_replayer.cpp testing/trace_replayer.h)
add_executable(aetrio_client ${AETRIO_CLIENT_SRC})
add_executable(aetrio_server ${AETRIO_SERVER_SRC})
add_executable(aetrio_task_scheduler ${AETRIO_TS_SRC})
add_executable(aetrio_worker_manager ${AETRIO_WM_SRC})
add_executable(aetrio_worker ${AETRIO_WS_SRC})

if(DEFINED MPI)
    target_link_libraries(aetrio_lib ${MPI_LIBRARIES})
    target_link_libraries(aetrio_client ${MPI_LIBRARIES})
    target_link_libraries(aetrio_server ${MPI_LIBRARIES})
    target_link_libraries(aetrio_task_scheduler ${MPI_LIBRARIES})
    target_link_libraries(aetrio_worker_manager ${MPI_LIBRARIES})
    target_link_libraries(aetrio_worker ${MPI_LIBRARIES})
endif()
if(DEFINED ROCKS)
    target_link_libraries(aetrio_lib -lrocksdb)
    target_link_libraries(aetrio_client -lrocksdb)
    target_link_libraries(aetrio_server -lrocksdb)
    target_link_libraries(aetrio_task_scheduler -lrocksdb)
    target_link_libraries(aetrio_worker_manager -lrocksdb)
    target_link_libraries(aetrio_worker -lrocksdb)
endif()
if(DEFINED MEMCACHED)
    target_link_libraries(aetrio_lib -L${LIB_DIR} -lmemcached)
    target_link_libraries(aetrio_client -L${LIB_DIR} -lmemcached)
    target_link_libraries(aetrio_server -L${LIB_DIR} -lmemcached)
    target_link_libraries(aetrio_task_scheduler -L${LIB_DIR} -lmemcached)
    target_link_libraries(aetrio_worker_manager -L${LIB_DIR} -lmemcached)
    target_link_libraries(aetrio_worker -L${LIB_DIR} -lmemcached)
endif()
if(DEFINED NATS)
    target_link_libraries(aetrio_lib -L${LIB_DIR} -lnats)
    target_link_libraries(aetrio_client -L${LIB_DIR} -lnats)
    target_link_libraries(aetrio_server -L${LIB_DIR} -lnats)
    target_link_libraries(aetrio_task_scheduler -L${LIB_DIR} -lnats)
    target_link_libraries(aetrio_worker_manager -L${LIB_DIR} -lnats)
    target_link_libraries(aetrio_worker -L${LIB_DIR} -lnats)
endif()
target_link_libraries(aetrio_lib -pthread)
target_link_libraries(aetrio_client -pthread)
target_link_libraries(aetrio_server -pthread)
target_link_libraries(aetrio_task_scheduler -pthread)
target_link_libraries(aetrio_worker_manager -pthread)
target_link_libraries(aetrio_worker -pthread)


#[[target_link_libraries(aetrio_lib ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
#target_link_libraries(aetrio_client ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
#target_link_libraries(aetrio_server ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
#target_link_libraries(aetrio_task_scheduler ${MPI_LIBRARIES} -pthread -lrocksdb  -lnats memcached)
#target_link_libraries(aetrio_worker_manager ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
#target_link_libraries(aetrio_worker ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
    #worker programs
#target_link_libraries(aetrio_worker_stats ${MPI_LIBRARIES} -pthread)]]
