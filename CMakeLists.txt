cmake_minimum_required(VERSION 3.5)
project(porus_main)

set(CMAKE_CXX_STANDARD 11)
include_directories(external_libs/)
#define ones we have installed
set(MEMCACHED true)
set(NATS true)
set(MPI true)
#set(ROCKS true)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DDEBUG -g")

set(CMAKE_MODULE_PATH )
set(COMMON_SRC "" src/common/solver/dp_solver.cpp src/common/solver/dp_solver.h src/common/solver/solver.h src/common/solver/greedy_solver.cpp src/common/solver/greedy_solver.h src/common/solver/knapsack.cpp external_libs/cereal/cereal.hpp src/common/timer.h src/common/timer.cpp src/common/enumerations.h src/common/exceptions.h src/common/data_structures.h src/common/data_manager/data_manager.cpp src/common/data_manager/data_manager.h src/common/client_interface/distributed_hashmap.cpp src/common/client_interface/distributed_hashmap.h src/common/utilities.h src/common/metadata_manager/metadata_manager.cpp src/common/metadata_manager/metadata_manager.h src/common/constants.h src/aetrio_system.cpp src/aetrio_system.h src/common/task_builder/task_builder.cpp src/common/task_builder/task_builder.h src/common/client_interface/distributed_hashmap.cpp src/common/client_interface/distributed_hashmap.h src/common/client_interface/distributed_queue.cpp src/common/client_interface/distributed_queue.h src/common/external_clients/serialization_manager.cpp src/common/external_clients/serialization_manager.h src/common/external_clients/rocksdb_impl.cpp src/common/external_clients/rocksdb_impl.h src/common/external_clients/memcached_impl.cpp src/common/external_clients/memcached_impl.h src/common/external_clients/nats_impl.cpp src/common/external_clients/nats_impl.h)
set(PORUS_LIB_SRC ${COMMON_SRC} src/lib/driver.cpp src/lib/posix.cpp src/lib/posix.h src/lib/mpi.cpp)
set(PORUS_CLIENT_SRC  ${COMMON_SRC} "src/client/main.cpp" src/client/client.cpp src/client/client.h src/common/exceptions.h src/lib/mpi.h include/porus.h )
set(PORUS_SERVER_SRC  ${COMMON_SRC} "src/system_manager/main.cpp")
set(PORUS_TS_SRC  ${COMMON_SRC} src/task_scheduler/main.cpp src/task_scheduler/task_scheduler_service.cpp src/task_scheduler/task_scheduler_service.h)
set(PORUS_WM_SRC  ${COMMON_SRC} "src/worker_manager/main.cpp")
set(PORUS_W_PROG_REPO src/worker/api/io_client.h src/worker/api/posix_client.cpp src/worker/api/posix_client.h src/worker/program_repo/statistics.h src/worker/program_repo/statistics.cpp)
set(PORUS_WS_SRC  ${COMMON_SRC} ${PORUS_W_PROG_REPO} src/worker/main.cpp src/worker/worker_service.cpp src/worker/worker_service.h)


if(DEFINED MPI)
    find_package(MPI REQUIRED)
    set(CMAKE_CXX_COMPILE_FLAGS ${CMAKE_CXX_COMPILE_FLAGS} ${MPI_COMPILE_FLAGS})
    set(CMAKE_CXX_LINK_FLAGS ${CMAKE_CXX_LINK_FLAGS} ${MPI_LINK_FLAGS})
    include_directories(${MPI_INCLUDE_PATH})
endif()
if(DEFINED MEMCACHED)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -L/opt/install/lib -lmemcached -DMEMCACHED_P")
endif()
if(DEFINED ROCKS)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DROCKS_P")
    include_directories(/home/hariharan/Downloads/rocksdb/include)
endif()
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -w")


add_executable(porus_lib ${PORUS_LIB_SRC})
add_executable(porus_client ${PORUS_CLIENT_SRC})
add_executable(porus_server ${PORUS_SERVER_SRC})
add_executable(porus_task_scheduler ${PORUS_TS_SRC})
add_executable(porus_worker_manager ${PORUS_WM_SRC})
add_executable(porus_worker ${PORUS_WS_SRC})

if(DEFINED MPI)
    target_link_libraries(porus_lib ${MPI_LIBRARIES})
    target_link_libraries(porus_client ${MPI_LIBRARIES})
    target_link_libraries(porus_server ${MPI_LIBRARIES})
    target_link_libraries(porus_task_scheduler ${MPI_LIBRARIES})
    target_link_libraries(porus_worker_manager ${MPI_LIBRARIES})
    target_link_libraries(porus_worker ${MPI_LIBRARIES})
endif()
if(DEFINED ROCKS)
    target_link_libraries(porus_lib -lrocksdb)
    target_link_libraries(porus_client -lrocksdb)
    target_link_libraries(porus_server -lrocksdb)
    target_link_libraries(porus_task_scheduler -lrocksdb)
    target_link_libraries(porus_worker_manager -lrocksdb)
    target_link_libraries(porus_worker -lrocksdb)
endif()
if(DEFINED MEMCACHED)
    target_link_libraries(porus_lib memcached)
    target_link_libraries(porus_client memcached)
    target_link_libraries(porus_server memcached)
    target_link_libraries(porus_task_scheduler memcached)
    target_link_libraries(porus_worker_manager memcached)
    target_link_libraries(porus_worker memcached)
endif()
if(DEFINED NATS)
    target_link_libraries(porus_lib -lnats)
    target_link_libraries(porus_client -lnats)
    target_link_libraries(porus_server -lnats)
    target_link_libraries(porus_task_scheduler -lnats)
    target_link_libraries(porus_worker_manager -lnats)
    target_link_libraries(porus_worker -lnats)
endif()
target_link_libraries(porus_lib -pthread)
target_link_libraries(porus_client -pthread)
target_link_libraries(porus_server -pthread)
target_link_libraries(porus_task_scheduler -pthread)
target_link_libraries(porus_worker_manager -pthread)
target_link_libraries(porus_worker -pthread)


#[[target_link_libraries(porus_lib ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
target_link_libraries(porus_client ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
target_link_libraries(porus_server ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
target_link_libraries(porus_task_scheduler ${MPI_LIBRARIES} -pthread -lrocksdb  -lnats memcached)
target_link_libraries(porus_worker_manager ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
target_link_libraries(porus_worker ${MPI_LIBRARIES} -pthread -lrocksdb -lnats memcached)
    #worker programs
target_link_libraries(porus_worker_stats ${MPI_LIBRARIES} -pthread)]]